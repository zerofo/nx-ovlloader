name: NX_CI

on:
  push:
    branches:
      - forward
  workflow_dispatch:
  release:
    types: [published]


jobs:
  build:
    runs-on: ubuntu-latest
    container: devkitpro/devkita64:latest

    steps:
    # - name: spliting string
    #   uses: winterjung/split@v2.1.0
    #   id: repo
    #   with:
    #     msg: ${{ github.repository }}
    #     separator: '/'
    - name: Checkout
      uses: actions/checkout@master
      with:
        ref: forward
        submodules: recursive
    - name: Build
      run: |
        git config --global --add safe.directory `pwd`
        make -j $(nproc)
        apt install imagemagick tree -y
        #tree .
        mkdir -p hblmenu_NSP/exefs
        mkdir -p hblmenu_NSP/romfs
        cp build/exefs/* hblmenu_NSP/exefs/
        wget https://raw.githubusercontent.com/switchbrew/nx-hbmenu/refs/heads/master/icon.jpg
        convert icon.jpg -resize 256x256! -alpha set -depth 8 rgba:icon.png
        cp icon.png hblmenu_NSP/romfs/NintendoLogo.png
        nacptool --create "hblmenu" "zerofo" "v0.1" hblmenu_NSP/control.nacp 
        ################### packing NSP #####################
        wget https://github.com/DeaconBlood/PROD.KEYS/releases/latest/download/prod.keys
        wget https://github.com/zerofo/hacBrewPack/releases/latest/download/hacbrewpack
        sudo -E chmod +x ./hacbrewpack
        ./hacbrewpack -k prod.keys --exefsdir hblmenu_NSP/exefs/ --controldir hblmenu_NSP/  --titleid 010078787878100D --romfsdir hblmenu_NSP/romfs --nologo --nspdir output
        mv ./output/010078787878100d.nsp ./output/hblmenu-NSP_010078787878100d.nsp
    - name: Upload file
      uses: actions/upload-artifact@v4
      with:
        # name: ${{ steps.repo.outputs._1 }} 
        path: ./output/hblmenu-NSP_010078787878100d.nsp
    - name: Upload binaries to release
      uses: svenstaro/upload-release-action@v2
      with:
        repo_token: ${{ secrets.release_token }}
        file: ./output/hblmenu-NSP_010078787878100d.nsp
        tag: ${{ github.ref }}
        overwrite: true
        file_glob: true
